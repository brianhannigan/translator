using Newtonsoft.Json;
using System;
using System.Diagnostics;
using System.IO;
using System.Net.Http;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Threading;
using Translator.Interfaces;
using VTEControls;

namespace Translator.Managers
{
    public class ServerManager : PropertyHandler, IModule, IServerManager
    {
        private enum ServerNames { OCR, TRANSLATE }

        /// <summary>
        /// The network manager
        /// </summary>
        private readonly INetworkManager m_networkManager;

        /// <summary>
        /// Cancellation token for ping task
        /// </summary>
        private CancellationTokenSource m_cancellationToken;

        /// <summary>
        /// Task for pinging the server
        /// </summary>
        private Task m_serverStatusTask;

        /// <summary>
        /// The status of the ocr server
        /// </summary>
        private ServerStatus m_ocrOnline;

        /// <summary>
        /// The status of the translator server
        /// </summary>
        private ServerStatus m_translateOnline;

        public ServerStatus OcrStatus
        {
            get { return m_ocrOnline; }
            set { SetProperty(GetPropertyName(), ref m_ocrOnline, value); }
        }

        public ServerStatus TranslatorStatus
        {
            get { return m_translateOnline; }
            set { SetProperty(GetPropertyName(), ref m_translateOnline, value); }
        }

        private const string C_FormattedHealthAddress = "http://{0}:{1}/health";

        public ServerManager(INetworkManager networkManager)
        {
            m_networkManager = networkManager;
            OcrStatus = ServerStatus.DISCONNECTED;
            TranslatorStatus = ServerStatus.DISCONNECTED;
        }

        public void OnStart()
        {
            if (m_networkManager == null)
                return;

            if (m_serverStatusTask != null)
                return;

            if (m_cancellationToken != null)
                m_cancellationToken.Cancel();

            m_cancellationToken = new CancellationTokenSource();
            m_serverStatusTask = new Task(() => CheckStatus(2000, m_cancellationToken));

            m_serverStatusTask.ContinueWith((task) =>
            {
                if (task == m_serverStatusTask)
                {
                    m_serverStatusTask = null;
                    m_cancellationToken = null;
                }
            });
            m_serverStatusTask.Start();
        }

        public void OnStop()
        {
            if (m_cancellationToken == null)
                return;
            m_cancellationToken.Cancel();
        }

        private void CheckStatus(int delay, CancellationTokenSource cts)
        {
            UpdateServerStatus();

            while (!cts.Token.IsCancellationRequested)
            {
                WaitHandle.WaitAny(new[] { cts.Token.WaitHandle }, delay);

                if (!cts.Token.IsCancellationRequested)
                {
                    UpdateServerStatus();
                }
            }
        }

        private void UpdateServerStatus()
        {
            if (m_networkManager == null)
                return;

            UpdateServerStatusAsync(string.Format(C_FormattedHealthAddress, m_networkManager.OcrIpAddress, m_networkManager.OcrPort), ServerNames.OCR);
            UpdateServerStatusAsync(string.Format(C_FormattedHealthAddress, m_networkManager.TranslationIpAddress, m_networkManager.TranslationPort), ServerNames.TRANSLATE);
        }

        private async void UpdateServerStatusAsync(string url, ServerNames server)
        {
            ServerStatus status;
            try
            {
                var client = new HttpClient { Timeout = TimeSpan.FromSeconds(5) };
                var response = await client.GetAsync(url);
                status = response.IsSuccessStatusCode ? ServerStatus.CONNECTED : ServerStatus.DISCONNECTED;
            }
            catch
            {
                status = ServerStatus.DISCONNECTED;
            }

            switch (server)
            {
                case ServerNames.OCR:
                    OcrStatus = status;
                    break;
                case ServerNames.TRANSLATE:
                    TranslatorStatus = status;
                    break;
            }
        }
    }
}
